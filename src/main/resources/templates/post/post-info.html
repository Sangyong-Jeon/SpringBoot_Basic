<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header"/>
<body>
<div class="container">
    <div th:replace="fragments/body-header :: bodyHeader"/>
    <div class="border-bottom">
        <h2 class="text-muted">제목</h2>
        <h3 th:text="${post.title}"></h3>
    </div>
    <div class="py-2 border-bottom">
        <h2 class="text-muted">내용</h2>
        <p th:text="${post.content}"></p>
        <div class="row justify-content-start py-2">
            <div class="col-3" th:each="storeImage : ${post.storeImageName}">
                <div class="text-center">
                    <img class="image" th:src="|/api/images/${storeImage.storeFileName}|" width="200" height="200">
                    <div>
                        <a th:href="@{/api/images/{fileId}/attach (fileId=${storeImage.id})}">
                            <small th:text="${storeImage.uploadFileName}"></small>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="row justify-content-start text-muted py-3">
            <span class="col col-lg-2"><small th:text="|작성자 : ${post.createdName}|"></small></span>
            <span class="col col-lg-4"><small th:text="|조회수 : ${post.viewCount}|"></small></span>
            <span class="col-3"><small th:text="|작성일시 : ${post.createdDate}|"></small></span>
            <span class="col-3"><small th:text="|수정일시 : ${post.updatedDate}|"></small></span>
        </div>
    </div>
    <div class="py-2 row justify-content-end">
        <div class="col-auto">
            <button type="button" class="btn btn-secondary" onclick="backPage()">돌아가기</button>
            <button class="btn btn-primary" onclick="validatePost()" sec:authorize="isAuthenticated()">수정</button>
            <button class="btn btn-primary" onclick="deletePost()" sec:authorize="isAuthenticated()">삭제</button>
        </div>
    </div>
    <div class="py-2 border-bottom">
        댓글
    </div>
    <div class="py-3">
        <textarea id="comment" placeholder="댓글을 입력하세요" style="width:100%" rows="3"></textarea>
        <button class="btn btn-primary" onclick="addComment()">댓글 등록</button>
    </div>
    <div class="py-3">
        등록한 댓글 보여지는 부분
    </div>
</div>
</body>
<script th:inline="javascript">

    /*<![CDATA[*/
    var postId = [[${post.id}]];
    console.log(postId);
    /*]]>*/

    const backPage = () => {
        location.href = "http://localhost:8081/posts"
    }

    const deletePost = () => {
        $.ajax({
            type: "DELETE",
            url: "/api/posts/" + postId,
            dataType: 'json',
            success: (res) => {
                alert(res.header.message);
                location.href = "/posts";
            },
            error: (err) => {
                const json = err.responseJSON.header;
                console.log(json);
                alert(json.message);
            }
        })
    }

    const validatePost = () => {
        $.ajax({
            method: "GET",
            url: "/api/posts/" + postId,
            success: (res) => {
                location.href = "/posts/" + postId + "/edit";
            },
            error: (err) => {
                const json = err.responseJSON.header;
                console.log(json);
                alert(json.message);
            }
        })
    }

    const addComment = () => {
        const commentForm = {
            content: $("#comment").val(),
            postId: postId,
        };

        $.ajax({
            method: "POST",
            url: "/api/comment",
            data: JSON.stringify(commentForm),
            contentType: 'application/json',
            success: (res) => {
                console.log(res);
                alert(res.header.message);
            },
            error: (err) => {
                console.log(err);
            }
        })
    }
</script>
</html>